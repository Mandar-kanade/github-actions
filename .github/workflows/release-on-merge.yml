name: Release on Merge

on:
  pull_request:
    types: [closed]
    branches:
      - main

permissions:
  contents: write
  pull-requests: write
  packages: write
  actions: read

env:
  MAVEN_OPTS: -Dhttp.keepAlive=false -Dmaven.wagon.http.pool=false -Dmaven.wagon.http.retryHandler.count=3

jobs:
  release:
    name: Create Release
    runs-on: ubuntu-latest
    if: github.event.pull_request.merged == true && startsWith(github.event.pull_request.head.ref, 'release/')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: main  # Checkout main branch where PR was merged
      
      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
      
      - name: Extract version from pom.xml
        id: version
        run: |
          # Use a more portable method to extract version
          # Match version tag that comes after artifactId=product-service
          VERSION=$(grep -A 1 "<artifactId>product-service</artifactId>" pom.xml | grep "<version>" | sed 's/.*<version>\([^<]*\)<\/version>.*/\1/')
          # Remove -SNAPSHOT if present
          VERSION=${VERSION%-SNAPSHOT}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Extracted version: $VERSION"
          
          if [ -z "$VERSION" ]; then
            echo "Error: Could not extract version from pom.xml"
            exit 1
          fi
      
      - name: Get merge commit SHA
        id: merge_commit
        run: |
          MERGE_SHA="${{ github.event.pull_request.merge_commit_sha }}"
          echo "merge_sha=$MERGE_SHA" >> $GITHUB_OUTPUT
          echo "Merge commit SHA: $MERGE_SHA"
      
      - name: Find CI/CD workflow run
        id: find_workflow
        uses: actions/github-script@v7
        with:
          script: |
            const mergeSha = '${{ steps.merge_commit.outputs.merge_sha }}';
            const workflowName = 'Java Product Service CI/CD';
            
            // Find the workflow run for the merge commit
            const { data: runs } = await github.rest.actions.listWorkflowRunsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'ci-cd.yml',
              head_sha: mergeSha,
              per_page: 1
            });
            
            if (runs.workflow_runs.length === 0) {
              throw new Error(`No workflow run found for commit ${mergeSha}`);
            }
            
            const workflowRun = runs.workflow_runs[0];
            console.log(`Found workflow run: ${workflowRun.id} (${workflowRun.status})`);
            
            // Wait for workflow to complete if still running
            let run = workflowRun;
            let attempts = 0;
            const maxAttempts = 60; // Wait up to 10 minutes (60 * 10s)
            
            while (run.status !== 'completed' && attempts < maxAttempts) {
              console.log(`Workflow run ${run.id} status: ${run.status}, waiting...`);
              await new Promise(resolve => setTimeout(resolve, 10000)); // Wait 10 seconds
              
              const { data: updatedRun } = await github.rest.actions.getWorkflowRun({
                owner: context.repo.owner,
                repo: context.repo.repo,
                run_id: run.id
              });
              run = updatedRun;
              attempts++;
            }
            
            if (run.status !== 'completed') {
              throw new Error(`Workflow run ${run.id} did not complete in time. Status: ${run.status}`);
            }
            
            if (run.conclusion !== 'success') {
              throw new Error(`Workflow run ${run.id} did not succeed. Conclusion: ${run.conclusion}`);
            }
            
            core.setOutput('workflow_run_id', run.id);
            core.setOutput('workflow_run_url', run.html_url);
      
      - name: Download JAR artifact from CI/CD workflow
        uses: dawidd6/action-download-artifact@v3
        with:
          workflow: ci-cd.yml
          commit: ${{ steps.merge_commit.outputs.merge_sha }}
          name: product-service-jar
          path: target
          if_no_artifact_found: fail
      
      - name: Prepare JAR file for release
        id: prepare_jar
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          
          # Find the JAR file in target directory
          JAR_FILE=$(find target -name "product-service-*.jar" -not -name "*-sources.jar" -not -name "*-javadoc.jar" | head -1)
          
          if [ -z "$JAR_FILE" ]; then
            echo "Error: JAR file not found in target directory"
            exit 1
          fi
          
          # Rename to match release version if needed
          RELEASE_JAR="target/product-service-${VERSION}.jar"
          if [ "$JAR_FILE" != "$RELEASE_JAR" ]; then
            cp "$JAR_FILE" "$RELEASE_JAR"
            echo "Copied JAR to: $RELEASE_JAR"
          fi
          
          echo "jar_path=$RELEASE_JAR" >> $GITHUB_OUTPUT
          ls -lh "$RELEASE_JAR"
      
      - name: Get changelog
        id: changelog
        run: |
          # Get the last release tag
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          
          if [ -z "$LAST_TAG" ]; then
            echo "No previous release found"
            CHANGELOG=$(git log --pretty=format:"- %s (%h)" --no-merges)
          else
            echo "Generating changelog since $LAST_TAG"
            CHANGELOG=$(git log ${LAST_TAG}..HEAD --pretty=format:"- %s (%h)" --no-merges)
          fi
          
          # Escape for GitHub API
          CHANGELOG_ESCAPED=$(echo "$CHANGELOG" | sed 's/"/\\"/g' | sed ':a;N;$!ba;s/\n/\\n/g')
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      
      - name: Create Git Tag
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          TAG="v${VERSION}"
          
          git tag -a "$TAG" -m "Release $TAG"
          git push origin "$TAG"
          
          echo "Created tag: $TAG"
      
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Tag and push Docker image with release version
        run: |
          REGISTRY="ghcr.io"
          IMAGE_NAME="${{ github.repository_owner }}/${{ github.event.repository.name }}"
          IMAGE_NAME_LOWER=$(echo "$REGISTRY/$IMAGE_NAME" | tr '[:upper:]' '[:lower:]')
          VERSION="${{ steps.version.outputs.version }}"
          MERGE_SHA="${{ steps.merge_commit.outputs.merge_sha }}"
          
          # The image was already built in ci-cd.yml with tag: main-{sha}
          SOURCE_TAG="main-${MERGE_SHA}"
          RELEASE_TAG="v${VERSION}"
          
          echo "Pulling existing Docker image: ${IMAGE_NAME_LOWER}:${SOURCE_TAG}"
          
          # Pull the existing image
          docker pull ${IMAGE_NAME_LOWER}:${SOURCE_TAG}
          
          # Tag it with release version
          docker tag ${IMAGE_NAME_LOWER}:${SOURCE_TAG} ${IMAGE_NAME_LOWER}:${RELEASE_TAG}
          docker tag ${IMAGE_NAME_LOWER}:${SOURCE_TAG} ${IMAGE_NAME_LOWER}:latest
          
          # Push the release tags
          docker push ${IMAGE_NAME_LOWER}:${RELEASE_TAG}
          docker push ${IMAGE_NAME_LOWER}:latest
          
          echo "âœ… Tagged and pushed Docker image: ${IMAGE_NAME_LOWER}:${RELEASE_TAG}"
          echo "âœ… Updated latest tag: ${IMAGE_NAME_LOWER}:latest"
      
      - name: Create GitHub Release and Upload Artifacts
        id: create-release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            ${{ steps.prepare_jar.outputs.jar_path }}
          tag_name: v${{ steps.version.outputs.version }}
          name: Release v${{ steps.version.outputs.version }}
          body: |
            ## Release v${{ steps.version.outputs.version }}
            
            ### Changes
            ${{ steps.changelog.outputs.changelog }}
            
            ### Installation
            ```bash
            # Download JAR
            wget https://github.com/${{ github.repository }}/releases/download/v${{ steps.version.outputs.version }}/product-service-${{ steps.version.outputs.version }}.jar
            ```
            
            ### Docker
            ```bash
            docker pull ghcr.io/${{ github.repository_owner }}/${{ github.event.repository.name }}:v${{ steps.version.outputs.version }}
            ```
            
            ### Build Information
            - **Commit**: `${{ steps.merge_commit.outputs.merge_sha }}`
            - **CI/CD Workflow**: [${{ steps.find_workflow.outputs.workflow_run_id }}](${{ steps.find_workflow.outputs.workflow_run_url }})
            - **Artifacts**: Reused from CI/CD pipeline (no rebuild)
          draft: false
          prerelease: false
          generate_release_notes: false
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'
      
      - name: Update develop branch version
        run: |
          git checkout develop
          git pull origin develop
          
          # Update version to next snapshot
          VERSION="${{ steps.version.outputs.version }}"
          IFS='.' read -r MAJOR MINOR PATCH <<< "$VERSION"
          NEXT_PATCH=$((PATCH + 1))
          NEXT_SNAPSHOT="${MAJOR}.${MINOR}.${NEXT_PATCH}-SNAPSHOT"
          
          # Update pom.xml using Python script
          python3 scripts/update-pom-version.py pom.xml "${NEXT_SNAPSHOT}"
          
          git add pom.xml
          if ! git diff --staged --quiet; then
            git commit -m "chore: bump version to ${NEXT_SNAPSHOT} after release"
            git push origin develop
          else
            echo "No version changes to commit"
          fi
      
      - name: Release Summary
        run: |
          echo "## ðŸŽ‰ Release Completed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: \`v${{ steps.version.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Tag**: \`v${{ steps.version.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Release**: https://github.com/${{ github.repository }}/releases/tag/v${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: \`${{ steps.merge_commit.outputs.merge_sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **CI/CD Workflow**: [${{ steps.find_workflow.outputs.workflow_run_id }}](${{ steps.find_workflow.outputs.workflow_run_url }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Artifacts (Reused from CI/CD)" >> $GITHUB_STEP_SUMMARY
          echo "- **JAR**: \`product-service-${{ steps.version.outputs.version }}.jar\` (from CI/CD workflow)" >> $GITHUB_STEP_SUMMARY
          echo "- **Docker**: \`ghcr.io/${{ github.repository_owner }}/${{ github.event.repository.name }}:v${{ steps.version.outputs.version }}\` (tagged from \`main-${{ steps.merge_commit.outputs.merge_sha }}\`)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“ Changelog" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.changelog.outputs.changelog }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

