name: Java Calculator CI/CD

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

permissions:
  contents: read
  checks: write
  pull-requests: write

# Global environment variables
env:
  MAVEN_OPTS: -Dhttp.keepAlive=false -Dmaven.wagon.http.pool=false -Dmaven.wagon.http.retryHandler.count=3

jobs:
  # ============================================
  # PARALLEL QUALITY CHECKS (Runs simultaneously)
  # ============================================
  
  lint:
    name: ðŸ” Lint with Checkstyle
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Java with Maven cache
        uses: ./.github/actions/setup-java-maven
      
      - name: Run Checkstyle
        run: mvn checkstyle:check -B -q
      
      - name: Upload Checkstyle report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: checkstyle-report
          path: target/checkstyle-result.xml
          if-no-files-found: ignore
          retention-days: 7

  format-check:
    name: ðŸ“ Format Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Java with Maven cache
        uses: ./.github/actions/setup-java-maven
      
      - name: Check code formatting
        run: |
          mvn formatter:validate -B -q
          if [ $? -ne 0 ]; then
            echo "âŒ Code formatting check failed!"
            echo "ðŸ’¡ Run 'mvn formatter:format' locally to format your code."
            exit 1
          else
            echo "âœ… Code formatting check passed!"
          fi

  # ============================================
  # BUILD AND TEST (Runs after checkout only)
  # ============================================
  
  build-and-test:
    name: ðŸ”¨ Build & Test
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Java with Maven cache
        uses: ./.github/actions/setup-java-maven
      
      # Compile once, use for both testing and packaging
      - name: Compile code
        run: mvn clean compile test-compile -B
      
      - name: Run tests
        run: mvn test -B
      
      - name: Generate test report
        if: always()
        run: mvn surefire-report:report -B
      
      - name: Build JAR (skip recompile)
        run: mvn package -DskipTests -Dmaven.compiler.skipMain=true -Dmaven.compiler.skipTest=true -B
      
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: |
            target/surefire-reports/
            target/site/
          retention-days: 7
      
      - name: Publish test report
        if: always()
        continue-on-error: true
        uses: dorny/test-reporter@v1
        with:
          name: JUnit Test Results
          path: target/surefire-reports/*.xml
          reporter: java-junit
          fail-on-error: false
      
      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: calculator-jar
          path: target/*.jar
          retention-days: 30
      
      - name: Display build info
        run: |
          echo "âœ… Build completed successfully!"
          echo "ðŸ“¦ Artifact details:"
          ls -lh target/*.jar

  # ============================================
  # QUALITY GATE (Waits for all jobs)
  # ============================================
  
  quality-gate:
    name: ðŸ“Š Quality Gate
    runs-on: ubuntu-latest
    needs: [lint, format-check, build-and-test]
    if: always()
    
    steps:
      - name: Check quality gate
        run: |
          lint_status="${{ needs.lint.result }}"
          format_status="${{ needs.format-check.result }}"
          build_test_status="${{ needs.build-and-test.result }}"
          
          echo "ðŸ” Lint: $lint_status"
          echo "ðŸ“ Format: $format_status"
          echo "ðŸ”¨ Build & Test: $build_test_status"
          
          if [ "$lint_status" == "failure" ] || [ "$format_status" == "failure" ] || [ "$build_test_status" == "failure" ]; then
            echo "âŒ Quality gate failed!"
            exit 1
          fi
          
          echo "âœ… Quality gate passed!"
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
      
      - name: Generate quality summary
        run: |
          echo "# ðŸ“Š Code Quality Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Pipeline Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ” Lint | ${{ needs.lint.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“ Format Check | ${{ needs.format-check.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ”¨ Build & Test | ${{ needs.build-and-test.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.lint.result }}" == "success" ] && \
             [ "${{ needs.format-check.result }}" == "success" ] && \
             [ "${{ needs.build-and-test.result }}" == "success" ]; then
            echo "## âœ… All checks passed!" >> $GITHUB_STEP_SUMMARY
          else
            echo "## âŒ Some checks failed!" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“ˆ Performance Metrics" >> $GITHUB_STEP_SUMMARY
          echo "- Workflow: \`${{ github.workflow }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Run: \`#${{ github.run_number }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Triggered by: \`${{ github.event_name }}\`" >> $GITHUB_STEP_SUMMARY
