name: Java Calculator CI/CD

on:
  push:
    branches: 
      - main
  pull_request:
    branches: 
      - main
      - develop
      - 'feature/**'
      - 'bugfix/**'
      - 'release/**'
      - 'hotfix/**'
  workflow_dispatch:

permissions:
  contents: read
  checks: write
  pull-requests: write

# Global environment variables
env:
  MAVEN_OPTS: -Dhttp.keepAlive=false -Dmaven.wagon.http.pool=false -Dmaven.wagon.http.retryHandler.count=3

  
jobs:
  # ============================================
  # PHASE 1: FAST QUALITY CHECKS (Parallel)
  # Run lightweight checks first to fail fast
  # ============================================
  
  lint:
    name: ðŸ” Lint with Checkstyle
    runs-on: ubuntu-latest
    if: ${{ github.ref != 'refs/heads/main' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Java with Maven cache
        uses: ./.github/actions/setup-java-maven
      
      - name: Run Checkstyle (standalone)
        run: mvn checkstyle:check -B -q
      
      - name: Upload Checkstyle report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: checkstyle-report
          path: target/checkstyle-result.xml
          if-no-files-found: ignore
          retention-days: 7

  format-check:
    name: ðŸ“ Format Check
    runs-on: ubuntu-latest
    if: ${{ github.ref != 'refs/heads/main' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Java with Maven cache
        uses: ./.github/actions/setup-java-maven
      
      - name: Check code formatting
        run: |
          mvn formatter:validate -B -q
          if [ $? -ne 0 ]; then
            echo "âŒ Code formatting check failed!"
            echo "ðŸ’¡ Run 'mvn formatter:format' locally to format your code."
            exit 1
          else
            echo "âœ… Code formatting check passed!"
          fi

  # ============================================
  # PHASE 2: BUILD AND TEST
  # Only runs if lint and format pass (fail-fast)
  # Skips duplicate checkstyle that's bound to validate phase
  # ============================================
  
  build-and-test:
    name: ðŸ”¨ Build & Test
    runs-on: ubuntu-latest
    needs: [lint, format-check]  # Wait for quality checks to pass
    if: ${{ github.ref != 'refs/heads/main' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Java with Maven cache
        uses: ./.github/actions/setup-java-maven
      
      # Optimized: Run clean, compile, test, and package in a single Maven invocation
      # This leverages Maven's reactor and avoids duplicate dependency resolution
      - name: Build and test (optimized single pass)
        run: mvn clean verify -Dcheckstyle.skip=true -B
      
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: |
            target/surefire-reports/
            target/site/
          retention-days: 7
      
      - name: Publish test report
        if: always()
        continue-on-error: true
        uses: dorny/test-reporter@v1
        with:
          name: JUnit Test Results
          path: target/surefire-reports/*.xml
          reporter: java-junit
          fail-on-error: false
      
      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: calculator-jar
          path: target/*.jar
          retention-days: 30
      
      - name: Display build info
        run: |
          echo "âœ… Build completed successfully!"
          echo "ðŸ“¦ Artifact details:"
          ls -lh target/*.jar

  # ============================================
  # PHASE 3: CODE QUALITY ANALYSIS
  # SonarCloud analysis with code coverage
  # ============================================
  
  sonarcloud:
    name: ðŸ”¬ SonarCloud Analysis
    runs-on: ubuntu-latest
    needs: [lint, format-check, build-and-test]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Shallow clones should be disabled for better analysis
      
      - name: Setup Java with Maven cache
        uses: ./.github/actions/setup-java-maven
      
      - name: Cache SonarCloud packages
        uses: actions/cache@v4
        with:
          path: ~/.sonar/cache
          key: ${{ runner.os }}-sonar
          restore-keys: ${{ runner.os }}-sonar
      
      - name: Build and analyze with SonarCloud
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # Needed to get PR information
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          mvn clean verify sonar:sonar \
            -Dsonar.projectKey=${{ github.repository_owner }}_${{ github.event.repository.name }} \
            -Dcheckstyle.skip=true \
            -B
      
      - name: Upload SonarCloud results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: sonarcloud-results
          path: target/sonar/
          if-no-files-found: ignore
          retention-days: 7

  codeql:
    name: ðŸ”¬ CodeQL Analysis
    runs-on: ubuntu-latest
    needs: [build-and-test]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Java with Maven cache
        uses: ./.github/actions/setup-java-maven

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: java

      - name: Autobuild
        uses: github/codeql-action/autobuild@v3

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3

  # ============================================
  # QUALITY GATE (Waits for all jobs)
  # ============================================
  
  quality-gate:
    name: ðŸ“Š Quality Gate
    runs-on: ubuntu-latest
    needs: [lint, format-check, build-and-test, sonarcloud, codeql]
    if: always()
    
    steps:
      - name: Check quality gate
        run: |
          lint_status="${{ needs.lint.result }}"
          format_status="${{ needs.format-check.result }}"
          build_test_status="${{ needs.build-and-test.result }}"
          sonar_status="${{ needs.sonarcloud.result }}"
          codeql_status="${{ needs.codeql.result }}"
          echo "ðŸ” Lint: $lint_status"
          echo "ðŸ“ Format: $format_status"
          echo "ðŸ”¨ Build & Test: $build_test_status"
          echo "ðŸ”¬ SonarCloud: $sonar_status"
          echo "ðŸ”¬ CodeQL: $codeql_status"
          if [ "$lint_status" == "failure" ] || [ "$format_status" == "failure" ] || [ "$build_test_status" == "failure" ] || [ "$sonar_status" == "failure" ] || [ "$codeql_status" == "failure" ]; then
            echo "âŒ Quality gate failed!"
            exit 1
          fi
          
          echo "âœ… Quality gate passed!"
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
      
      - name: Generate quality summary
        run: |
          echo "# ðŸ“Š Code Quality Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Pipeline Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ” Lint | ${{ needs.lint.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“ Format Check | ${{ needs.format-check.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ”¨ Build & Test | ${{ needs.build-and-test.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ”¬ SonarCloud | ${{ needs.sonarcloud.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ”¬ CodeQL | ${{ needs.codeql.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.lint.result }}" == "success" ] && \
             [ "${{ needs.format-check.result }}" == "success" ] && \
             [ "${{ needs.build-and-test.result }}" == "success" ] && \
             [ "${{ needs.sonarcloud.result }}" == "success" ] && \
             [ "${{ needs.codeql.result }}" == "success" ]; then
            echo "## âœ… All checks passed!" >> $GITHUB_STEP_SUMMARY
          else
            echo "## âŒ Some checks failed!" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“ˆ Performance Metrics" >> $GITHUB_STEP_SUMMARY
          echo "- Workflow: \`${{ github.workflow }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Run: \`#${{ github.run_number }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Triggered by: \`${{ github.event_name }}\`" >> $GITHUB_STEP_SUMMARY
