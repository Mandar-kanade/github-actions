name: Java Product Service CI/CD

on:
  push:
    branches: 
      - main
  pull_request:
    branches: 
      - main
      - develop
      - 'feature/**'
      - 'bugfix/**'
      - 'release/**'
      - 'hotfix/**'
  workflow_dispatch:

permissions:
  contents: read
  checks: write
  pull-requests: write

# Global environment variables
env:
  MAVEN_OPTS: -Dhttp.keepAlive=false -Dmaven.wagon.http.pool=false -Dmaven.wagon.http.retryHandler.count=3

  
jobs:
  # ============================================
  # PHASE 1: FAST QUALITY CHECKS (Parallel)
  # Run lightweight checks first to fail fast
  # ============================================
  
  lint:
    name: ðŸ” Lint with Checkstyle
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        # Default fetch-depth: 1 (shallow clone) is sufficient
      
      - name: Setup Java with Maven cache
        uses: ./.github/actions/setup-java-maven
      
      - name: Run Checkstyle (standalone)
        run: mvn checkstyle:check -B -q
      
      - name: Upload Checkstyle report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: checkstyle-report
          path: target/checkstyle-result.xml
          if-no-files-found: ignore
          retention-days: 7

  format-check:
    name: ðŸ“ Format Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        # Default fetch-depth: 1 (shallow clone) is sufficient
      
      - name: Setup Java with Maven cache
        uses: ./.github/actions/setup-java-maven
      
      - name: Check code formatting
        run: |
          mvn formatter:validate -B -q
          if [ $? -ne 0 ]; then
            echo "âŒ Code formatting check failed!"
            echo "ðŸ’¡ Run 'mvn formatter:format' locally to format your code."
            exit 1
          else
            echo "âœ… Code formatting check passed!"
          fi

  # ============================================
  # PHASE 2: BUILD AND TEST
  # Only runs if lint and format pass (fail-fast)
  # Skips duplicate checkstyle that's bound to validate phase
  # ============================================
  
  build-and-test:
    name: ðŸ”¨ Build & Test
    runs-on: ubuntu-latest
    needs: [lint, format-check]  # Wait for quality checks to pass
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        # Default fetch-depth: 1 (shallow clone) is sufficient
      
      - name: Setup Java with Maven cache
        uses: ./.github/actions/setup-java-maven
      
      # Optimized: Run clean, compile, test, and package in a single Maven invocation
      # This leverages Maven's reactor and avoids duplicate dependency resolution
      - name: Build and test (optimized single pass)
        run: mvn clean verify -Dcheckstyle.skip=true -B
      
      - name: Upload test results and build artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: |
            target/surefire-reports/
            target/site/
            target/classes/
          retention-days: 7
      
      - name: Publish test report
        if: always()
        continue-on-error: true
        uses: dorny/test-reporter@v1
        with:
          name: JUnit Test Results
          path: target/surefire-reports/*.xml
          reporter: java-junit
          fail-on-error: false
      
      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: product-service-jar
          path: target/*.jar
          retention-days: 30
      
      - name: Display build info
        run: |
          echo "âœ… Build completed successfully!"
          echo "ðŸ“¦ Artifact details:"
          ls -lh target/*.jar

  # ============================================
  # PHASE 3: CODE QUALITY ANALYSIS
  # SonarCloud analysis with code coverage
  # ============================================
  
  sonarcloud:
    name: ðŸ”¬ SonarCloud Analysis
    runs-on: ubuntu-latest
    needs: [build-and-test]  # Only need build, lint/format already validated
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Shallow clones should be disabled for better analysis
      
      - name: Setup Java with Maven cache
        uses: ./.github/actions/setup-java-maven
      
      - name: Download test results and coverage
        uses: actions/download-artifact@v4
        with:
          name: test-results
          path: target/
      
      - name: Cache SonarCloud packages
        uses: actions/cache@v4
        with:
          path: ~/.sonar/cache
          key: ${{ runner.os }}-sonar
          restore-keys: ${{ runner.os }}-sonar
      
      - name: Analyze with SonarCloud (skip tests, reuse coverage)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # Needed to get PR information
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          # Skip tests since they're already run - saves ~30-60 seconds
          # Reuse existing JaCoCo coverage report
          mvn compile sonar:sonar \
            -Dsonar.projectKey=${{ github.repository_owner }}_${{ github.event.repository.name }} \
            -Dsonar.java.binaries=target/classes \
            -Dsonar.coverage.jacoco.xmlReportPaths=target/site/jacoco/jacoco.xml \
            -Dcheckstyle.skip=true \
            -DskipTests=true \
            -B
      
      - name: Upload SonarCloud results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: sonarcloud-results
          path: target/sonar/
          if-no-files-found: ignore
          retention-days: 7

  codeql:
    name: ðŸ”¬ CodeQL Analysis
    runs-on: ubuntu-latest
    needs: [build-and-test]
    permissions:
      contents: read
      pull-requests: write
      security-events: write
      actions: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history needed for better CodeQL analysis

      - name: Setup Java with Maven cache
        uses: ./.github/actions/setup-java-maven

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: java

      - name: Perform CodeQL Analysis (reuse build)
        uses: github/codeql-action/autobuild@v3
        # CodeQL will detect existing build artifacts and skip rebuild if possible

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3


  # ============================================
  # PHASE 4: Docker Build and Push
  # Build the application and push it to a container registry
  # ============================================
  
  docker-build-and-push:
    name: ðŸš€ Docker Build and Push
    runs-on: ubuntu-latest
    needs: [build-and-test]
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        # Default fetch-depth: 1 (shallow clone) is sufficient

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver-opts: |
            image=moby/buildkit:latest

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract branch name
        id: vars
        run: |
          BRANCH=${GITHUB_REF#refs/heads/}
          SAFE_BRANCH=$(echo "$BRANCH" | tr '/' '-')
          echo "branch=$BRANCH" >> $GITHUB_OUTPUT
          echo "safe_branch=$SAFE_BRANCH" >> $GITHUB_OUTPUT

      - name: Build and push Docker image
        env:
          REGISTRY: ghcr.io
          IMAGE_NAME: ${{ github.repository_owner }}/${{ github.event.repository.name }}
        run: |
          # Force image name to lowercase (GHCR/Docker requirement)
          IMAGE_NAME_LOWER=$(echo "$REGISTRY/$IMAGE_NAME" | tr '[:upper:]' '[:lower:]')
          PRIMARY_TAG="${{ steps.vars.outputs.safe_branch }}-${{ github.sha }}"
      
          echo "Building image: $IMAGE_NAME_LOWER:$PRIMARY_TAG"
      
          # Build and push using Buildx with cache and multiple tags
          # Cache from previous builds to speed up subsequent builds
          BUILDX_ARGS=(
            --platform linux/amd64
            --cache-from type=registry,ref=$IMAGE_NAME_LOWER:${{ steps.vars.outputs.safe_branch }}
            --cache-to type=inline
            --tag $IMAGE_NAME_LOWER:$PRIMARY_TAG
            --tag $IMAGE_NAME_LOWER:${{ steps.vars.outputs.safe_branch }}
            --tag $IMAGE_NAME_LOWER:${{ github.run_number }}
            --push
          )
          
          # Add latest tag for main branch
          if [ "${{ steps.vars.outputs.safe_branch }}" = "main" ]; then
            BUILDX_ARGS+=(--tag $IMAGE_NAME_LOWER:latest)
          fi
      
          docker buildx build "${BUILDX_ARGS[@]}" .
          
          echo "âœ… Successfully built and pushed all tags"

  # ============================================
  # QUALITY GATE (Waits for all jobs)
  # ============================================
  
  quality-gate:
    name: ðŸ“Š Quality Gate
    runs-on: ubuntu-latest
    needs: [lint, format-check, build-and-test, sonarcloud, codeql, docker-build-and-push]
    if: always()
    outputs:
      passed: ${{ steps.gate-check.outputs.passed }}
    
    steps:
      - name: Check quality gate
        id: gate-check
        run: |
          lint_status="${{ needs.lint.result }}"
          format_status="${{ needs.format-check.result }}"
          build_test_status="${{ needs.build-and-test.result }}"
          sonar_status="${{ needs.sonarcloud.result }}"
          codeql_status="${{ needs.codeql.result }}"
          docker_status="${{ needs.docker-build-and-push.result }}"
          
          echo "ðŸ” Lint: $lint_status"
          echo "ðŸ“ Format: $format_status"
          echo "ðŸ”¨ Build & Test: $build_test_status"
          echo "ðŸ”¬ SonarCloud: $sonar_status"
          echo "ðŸ”¬ CodeQL: $codeql_status"
          echo "ðŸ³ Docker: $docker_status"
          
          if [ "$lint_status" == "failure" ] || [ "$format_status" == "failure" ] || [ "$build_test_status" == "failure" ] || [ "$sonar_status" == "failure" ] || [ "$codeql_status" == "failure" ] || [ "$docker_status" == "failure" ]; then
            echo "âŒ Quality gate failed!"
            echo "passed=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          echo "âœ… Quality gate passed!"
          echo "passed=true" >> $GITHUB_OUTPUT
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
      
      - name: Generate quality summary
        run: |
          echo "# ðŸ“Š Code Quality Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Pipeline Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ” Lint | ${{ needs.lint.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“ Format Check | ${{ needs.format-check.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ”¨ Build & Test | ${{ needs.build-and-test.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ”¬ SonarCloud | ${{ needs.sonarcloud.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ”¬ CodeQL | ${{ needs.codeql.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ³ Docker | ${{ needs.docker-build-and-push.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.lint.result }}" == "success" ] && \
             [ "${{ needs.format-check.result }}" == "success" ] && \
             [ "${{ needs.build-and-test.result }}" == "success" ] && \
             [ "${{ needs.sonarcloud.result }}" == "success" ] && \
             [ "${{ needs.codeql.result }}" == "success" ] && \
             [ "${{ needs.docker-build-and-push.result }}" == "success" ]; then
            echo "## âœ… All checks passed!" >> $GITHUB_STEP_SUMMARY
          else
            echo "## âŒ Some checks failed!" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“ˆ Performance Metrics" >> $GITHUB_STEP_SUMMARY
          echo "- Workflow: \`${{ github.workflow }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Run: \`#${{ github.run_number }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Triggered by: \`${{ github.event_name }}\`" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # PHASE 5: DEPLOY TO RENDER.COM
  # Only runs on main branch after quality gate passes
  # ============================================
  
  deploy-to-render:
    name: ðŸš€ Deploy to Render.com
    runs-on: ubuntu-latest
    needs: [quality-gate, docker-build-and-push]
    if: |
      github.ref == 'refs/heads/main' &&
      github.event_name == 'push' &&
      needs.quality-gate.outputs.passed == 'true'
    environment:
      name: production
      url: ${{ steps.deploy.outputs.service_url }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Prepare Docker image details
        id: image
        run: |
          # Construct the image URL from GHCR
          REGISTRY="ghcr.io"
          IMAGE_NAME="${{ github.repository_owner }}/${{ github.event.repository.name }}"
          IMAGE_NAME_LOWER=$(echo "$REGISTRY/$IMAGE_NAME" | tr '[:upper:]' '[:lower:]')
          IMAGE_TAG="main-${{ github.sha }}"
          FULL_IMAGE="${IMAGE_NAME_LOWER}:${IMAGE_TAG}"
          
          echo "ðŸ“¦ Docker Image: $FULL_IMAGE"
          echo "image_url=$FULL_IMAGE" >> $GITHUB_OUTPUT
          echo "image_tag=$IMAGE_TAG" >> $GITHUB_OUTPUT
      
      - name: Deploy Docker image to Render
        id: deploy
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
          RENDER_SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID }}
          IMAGE_URL: ${{ steps.image.outputs.image_url }}
        run: |
          echo "ðŸš€ Starting deployment to Render.com..."
          echo "ðŸ³ Deploying image: $IMAGE_URL"
          
          # Trigger Render deployment with specific Docker image
          RESPONSE=$(curl -X POST "https://api.render.com/v1/services/${RENDER_SERVICE_ID}/deploys" \
            -H "Accept: application/json" \
            -H "Authorization: Bearer ${RENDER_API_KEY}" \
            -H "Content-Type: application/json" \
            -d "{
              \"clearCache\": \"do_not_clear\",
              \"imageUrl\": \"$IMAGE_URL\"
            }")
          
          echo "Render API Response: $RESPONSE"
          
          # Extract deploy ID from response
          DEPLOY_ID=$(echo $RESPONSE | jq -r '.id')
          
          if [ "$DEPLOY_ID" != "null" ] && [ -n "$DEPLOY_ID" ]; then
            echo "âœ… Deployment triggered successfully!"
            echo "Deploy ID: $DEPLOY_ID"
            echo "deploy_id=$DEPLOY_ID" >> $GITHUB_OUTPUT
            
            # Get service URL
            SERVICE_INFO=$(curl -X GET "https://api.render.com/v1/services/${RENDER_SERVICE_ID}" \
              -H "Accept: application/json" \
              -H "Authorization: Bearer ${RENDER_API_KEY}")
            
            SERVICE_URL=$(echo $SERVICE_INFO | jq -r '.serviceDetails.url // .service.serviceDetails.url // empty')
            
            if [ -n "$SERVICE_URL" ]; then
              echo "service_url=https://$SERVICE_URL" >> $GITHUB_OUTPUT
              echo "ðŸŒ Service URL: https://$SERVICE_URL"
            fi
          else
            echo "âŒ Deployment failed!"
            echo "Error: $(echo $RESPONSE | jq -r '.message // .error // \"Unknown error\"')"
            exit 1
          fi
      
      - name: Wait for deployment completion
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
          RENDER_SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID }}
          DEPLOY_ID: ${{ steps.deploy.outputs.deploy_id }}
        run: |
          echo "â³ Waiting for deployment to complete..."
          
          MAX_WAIT=600  # 10 minutes
          ELAPSED=0
          INTERVAL=15
          
          while [ $ELAPSED -lt $MAX_WAIT ]; do
            DEPLOY_STATUS=$(curl -s -X GET "https://api.render.com/v1/services/${RENDER_SERVICE_ID}/deploys/${DEPLOY_ID}" \
              -H "Accept: application/json" \
              -H "Authorization: Bearer ${RENDER_API_KEY}" | jq -r '.status')
            
            echo "Current status: $DEPLOY_STATUS (${ELAPSED}s elapsed)"
            
            if [ "$DEPLOY_STATUS" == "live" ]; then
              echo "âœ… Deployment completed successfully!"
              exit 0
            elif [ "$DEPLOY_STATUS" == "build_failed" ] || [ "$DEPLOY_STATUS" == "deactivated" ]; then
              echo "âŒ Deployment failed with status: $DEPLOY_STATUS"
              exit 1
            fi
            
            sleep $INTERVAL
            ELAPSED=$((ELAPSED + INTERVAL))
          done
          
          echo "âš ï¸ Deployment timeout reached (${MAX_WAIT}s)"
          echo "Please check Render dashboard for deployment status"
          exit 1
      
      - name: Deployment summary
        if: always()
        run: |
          echo "# ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Production Deployment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Service**: Render.com" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: main" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Docker Image**: \`${{ steps.image.outputs.image_url }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Image Tag**: \`${{ steps.image.outputs.image_tag }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Deploy ID**: \`${{ steps.deploy.outputs.deploy_id }}\`" >> $GITHUB_STEP_SUMMARY
          
          if [ -n "${{ steps.deploy.outputs.service_url }}" ]; then
            echo "- **URL**: ${{ steps.deploy.outputs.service_url }}" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ³ Docker Image Details" >> $GITHUB_STEP_SUMMARY
          echo "The deployment uses the Docker image built and pushed to GitHub Container Registry (GHCR)." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "docker pull ${{ steps.image.outputs.image_url }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… **Deployment completed successfully!**" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Deployment failed!**" >> $GITHUB_STEP_SUMMARY
          fi