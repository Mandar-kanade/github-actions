name: Java Calculator CI/CD

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  lint:
    name: Lint with Checkstyle
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up JDK 11
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'temurin'
          cache: 'maven'
      
      - name: Run Checkstyle
        run: mvn checkstyle:check
      
      - name: Upload Checkstyle report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: checkstyle-report
          path: target/checkstyle-result.xml
          if-no-files-found: ignore

  format-check:
    name: Format Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up JDK 11
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'temurin'
          cache: 'maven'
      
      - name: Check code formatting
        run: |
          mvn formatter:validate
          if [ $? -ne 0 ]; then
            echo "âŒ Code formatting check failed!"
            echo "Please run 'mvn formatter:format' locally to format your code."
            exit 1
          else
            echo "âœ… Code formatting check passed!"
          fi
      
      - name: Format code (for demonstration)
        if: failure()
        run: mvn formatter:format

  test:
    name: Run Tests
    runs-on: ubuntu-latest
    needs: [lint, format-check]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up JDK 11
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'temurin'
          cache: 'maven'
      
      - name: Run tests
        run: mvn test
      
      - name: Generate test report
        if: always()
        run: mvn surefire-report:report
      
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: |
            target/surefire-reports/
            target/site/
      
      - name: Publish test report
        if: always()
        uses: dorny/test-reporter@v1
        with:
          name: JUnit Test Results
          path: target/surefire-reports/*.xml
          reporter: java-junit
          fail-on-error: true

  build:
    name: Build Application
    runs-on: ubuntu-latest
    needs: [test]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up JDK 11
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'temurin'
          cache: 'maven'
      
      - name: Build with Maven
        run: mvn clean package -DskipTests
      
      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: calculator-jar
          path: target/*.jar
          retention-days: 30
      
      - name: Display build info
        run: |
          echo "âœ… Build completed successfully!"
          echo "ðŸ“¦ Artifact details:"
          ls -lh target/*.jar

  code-quality:
    name: Code Quality Report
    runs-on: ubuntu-latest
    needs: [lint, format-check, test, build]
    if: always()
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
      
      - name: Generate quality summary
        run: |
          echo "# Code Quality Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Pipeline Status" >> $GITHUB_STEP_SUMMARY
          echo "- Lint: ${{ needs.lint.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Format Check: ${{ needs.format-check.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Tests: ${{ needs.test.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Build: ${{ needs.build.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… All checks completed!" >> $GITHUB_STEP_SUMMARY
