name: Java Calculator CI/CD

on:
  push:
    branches: 
      - main
      - develop
      - 'feature/**'
      - 'release/**'
      - 'hotfix/**'
  pull_request:
    branches: 
      - main
      - develop
      - 'feature/**'
      - 'release/**'
      - 'hotfix/**'
  workflow_dispatch:

permissions:
  contents: read
  checks: write
  pull-requests: write

# Global environment variables
env:
  MAVEN_OPTS: -Dhttp.keepAlive=false -Dmaven.wagon.http.pool=false -Dmaven.wagon.http.retryHandler.count=3

jobs:
  # ============================================
  # PHASE 1: FAST QUALITY CHECKS (Parallel)
  # Run lightweight checks first to fail fast
  # ============================================
  
  lint:
    name: ğŸ” Lint with Checkstyle
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Java with Maven cache
        uses: ./.github/actions/setup-java-maven
      
      - name: Run Checkstyle (standalone)
        run: mvn checkstyle:check -B -q
      
      - name: Upload Checkstyle report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: checkstyle-report
          path: target/checkstyle-result.xml
          if-no-files-found: ignore
          retention-days: 7

  format-check:
    name: ğŸ“ Format Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Java with Maven cache
        uses: ./.github/actions/setup-java-maven
      
      - name: Check code formatting
        run: |
          mvn formatter:validate -B -q
          if [ $? -ne 0 ]; then
            echo "âŒ Code formatting check failed!"
            echo "ğŸ’¡ Run 'mvn formatter:format' locally to format your code."
            exit 1
          else
            echo "âœ… Code formatting check passed!"
          fi

  check-cache:
    name: ğŸ§© Check Maven Cache
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Java with Maven cache
        uses: ./.github/actions/setup-java-maven

      - name: Check Maven cache contents
        shell: bash
        run: |
          echo "ğŸ” Checking Maven cache..."
          if [ -d ~/.m2/repository ]; then
            echo "âœ… Maven cache directory exists."
            echo "ğŸ“¦ Cache size:"
            du -sh ~/.m2/repository
            echo ""
            echo "ğŸ“ Total cached files:"
            find ~/.m2/repository | wc -l
            echo ""
            echo "ğŸ”‘ Cache key used: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}"
          else
            echo "âŒ Cache not found!"
          fi

      - name: Display Maven version
        run: mvn -v
  
